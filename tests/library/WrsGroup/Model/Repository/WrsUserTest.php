<?php
require_once realpath(APPLICATION_PATH . '/../tests/ModelTestCase.php');

class WrsGroup_Model_Repository_WrsUserTest extends ModelTestCase
{
    protected $_ldapUserData = array(
        'accountexpires' =>
          array(
            0 => '0',),
        'admincount' =>
          array(
            0 => '1',),
        'badpasswordtime' =>
          array(
            0 => '129222960218156486',),
        'badpwdcount' =>
          array(
            0 => '0',),
        'cn' =>
          array(
            0 => 'Eugene Morgan',),
        'codepage' =>
          array(
            0 => '0',),
        'company' =>
          array(
            0 => 'WRS Group. LTD',),
        'countrycode' =>
          array(
            0 => '0',),
        'department' =>
          array(
            0 => 'Information Technology',),
        'description' =>
          array(
            0 => 'Eugene Morgan - Infomation Technology',),
        'displayname' =>
          array(
            0 => 'Eugene Morgan',),
        'distinguishedname' =>
          array(
            0 => 'CN=Eugene Morgan,CN=Users,DC=wntdom,DC=wrsgroup,DC=com',),
        'dn' => 'CN=Eugene Morgan,CN=Users,DC=wntdom,DC=wrsgroup,DC=com',
        'givenname' =>
          array(
            0 => 'Eugene',),
        'homemdb' =>
          array(
            0 => 'CN=Mailbox Database 0479311809,CN=Databases,CN=Exchange Administrative Group (FYDIBOHF23SPDLT),CN=Administrative Groups,CN=WRS Group,CN=Microsoft Exchange,CN=Services,CN=Configuration,DC=wntdom,DC=wrsgroup,DC=com',),
        'homemta' =>
          array(
            0 => 'CN=Microsoft MTA,CN=WRS-MAIL,CN=Servers,CN=Exchange Administrative Group (FYDIBOHF23SPDLT),CN=Administrative Groups,CN=WRS Group,CN=Microsoft Exchange,CN=Services,CN=Configuration,DC=wntdom,DC=wrsgroup,DC=com',),
        'instancetype' =>
          array(
            0 => '4',),
        'lastlogoff' =>
          array(
            0 => '0',),
        'lastlogon' =>
          array(
            0 => '129222282457220286',),
        'lastlogontimestamp' =>
          array(
            0 => '129216113286021873',),
        'legacyexchangedn' =>
          array(
            0 => '/o=WRS Group/ou=Exchange Administrative Group (FYDIBOHF23SPDLT)/cn=Recipients/cn=Eugene Morgan',),
        'logoncount' =>
          array(
            0 => '1415',),
        'logonhours' =>
          array(
            0 => 'ÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿ',),
        'mail' =>
          array(
            0 => 'EugeneMorgan@wrsgroup.com',),
        'mailnickname' =>
          array(
            0 => 'EugeneMorgan',),
        'manager' =>
          array(
            0 => 'CN=Ted Trepinski,CN=Users,DC=wntdom,DC=wrsgroup,DC=com',),
        'mdbusedefaults' =>
          array(
            0 => 'TRUE',),
        'memberof' =>
          array(
            0 => 'CN=BBB Ship Plan Editors,CN=Users,DC=wntdom,DC=wrsgroup,DC=com',
            1 => 'CN=AS/400_Users,CN=Users,DC=wntdom,DC=wrsgroup,DC=com',
            2 => 'CN=Information Technology,CN=Users,DC=wntdom,DC=wrsgroup,DC=com',
            3 => 'CN=Domain Admins,CN=Users,DC=wntdom,DC=wrsgroup,DC=com',),
        'msexchhomeservername' =>
          array(
            0 => '/o=WRS Group/ou=Exchange Administrative Group (FYDIBOHF23SPDLT)/cn=Configuration/cn=Servers/cn=WRS-MAIL',),
        'msexchmailboxguid' =>
          array(
            0 => 'ÞþO2âðD™\þÏV>z',),
        'msexchmailboxsecuritydescriptor' =>
          array(
            0 => '&#0;€&#0;&#0;&#0; &#0;&#0;&#0;&#0;&#0;&#0;&#0;,&#0;&#0;&#0;&#0;&#0;&#0;&#0;&#0;),
&#0;&#0;&#0;&#0;&#0;&#0;&#0;&#0;
&#0;&#0;&#0;&#0;&#0;&#0;&#0;&#0;&#0;&#0;&#0;&#0;&#0;&#0;&#0;&#0;&#0;
&#0;&#0;&#0;',
        'msexchpoliciesincluded' =>
          array(
            0 => 'b99fde18-08d3-4163-8aa3-c71cc4100d6d',),
            1 => '{26491cfc-9e50-4857-861b-0cb8df22b5d7}',),
        'msexchprevioushomemdb' =>
          array(
            0 => 'CN=Mailbox Database 0479311809,CN=Databases,CN=Exchange Administrative Group (FYDIBOHF23SPDLT),CN=Administrative Groups,CN=WRS Group,CN=Microsoft Exchange,CN=Services,CN=Configuration,DC=wntdom,DC=wrsgroup,DC=com',),
        'msexchrbacpolicylink' =>
          array(
            0 => 'CN=Default Role Assignment Policy,CN=Policies,CN=RBAC,CN=WRS Group,CN=Microsoft Exchange,CN=Services,CN=Configuration,DC=wntdom,DC=wrsgroup,DC=com',),
        'msexchrecipientdisplaytype' =>
          array(
            0 => '1073741824',),
        'msexchrecipienttypedetails' =>
          array(
            0 => '1',),
        'msexchtextmessagingstate' =>
          array(
            0 => '302120705',
            1 => '16842751',),
        'msexchumdtmfmap' =>
          array(
            0 => 'emailAddress:384363667426',
            1 => 'lastNameFirstName:667426384363',
            2 => 'firstNameLastName:384363667426',),
        'msexchuseraccountcontrol' =>
          array(
            0 => '0',),
        'msexchversion' =>
          array(
            0 => '44220983382016',),
        'msmqdigests' =>
          array(
            0 => 'óÐsçòà,øÕoÅƒ•µ',),
        'msmqsigncertificates' =>
          array(
            0 => '&#0;&#0;&#0;óÐsçòà,øÕoÅƒ•µ}î¹$ ÃK°¨Cæ^àOÕ&#0;&#0;0‚Ñ0‚{ ª¥ZU0*†H†÷
&#0;0p10U&#0;M&#0;S&#0;M&#0;Q10	U
&#0;-10	U&#0;-1A0?U8&#0;W&#0;N&#0;T&#0;D&#0;O&#0;M&#0;\&#0;e&#0;m&#0;o&#0;r&#0;g&#0;a&#0;n&#0;,&#0; &#0;o&#0;p&#0;t&#0;i&#0;p&#0;l&#0;e&#0;x&#0;1&#0;7&#0;0&#0;l0
090224155023Z
170224155023Z0p10U&#0;M&#0;S&#0;M&#0;Q10	U
&#0;-10	U&#0;-1A0?U8&#0;W&#0;N&#0;T&#0;D&#0;O&#0;M&#0;\&#0;e&#0;m&#0;o&#0;r&#0;g&#0;a&#0;n&#0;,&#0; &#0;o&#0;p&#0;t&#0;i&#0;p&#0;l&#0;e&#0;x&#0;1&#0;7&#0;0&#0;l0\0
	*†H†÷
&#0;K&#0;0HA&#0;Æì4ÓsO#«ò@›ôdƒ.OôJ "Ü`×áµJq!K‘è´ªrÇ3þðŸ‘¶}=–Ê‚Õê·&#0;0
	*†H†÷
&#0;A&#0;µ3â{V¤y5¸k>2Sø.?²Áï+÷²9wË/¦÷w˜žE¦½ë	o]&{ø¾º†xø>þ÷JðÉ%ù1',),
        'name' =>
          array(
            0 => 'Eugene Morgan',),
        'objectcategory' =>
          array(
            0 => 'CN=Person,CN=Schema,CN=Configuration,DC=wntdom,DC=wrsgroup,DC=com',),
        'objectclass' =>
          array(
            0 => 'top',
            1 => 'person',
            2 => 'organizationalPerson',
            3 => 'user',),
        'objectguid' =>
          array(
            0 => '{–ï"…AE­Ùvz4í),
…',
        'objectsid' =>
          array(
            0 => '&#0;&#0;&#0;&#0;&#0;&#0;&#0;&#0; l|^\±Híd/A&#0;&#0;',),
        'physicaldeliveryofficename' =>
          array(
            0 => 'Franklin',),
        'primarygroupid' =>
          array(
            0 => '513',),
        'proxyaddresses' =>
          array(
            0 => 'SMTP:EugeneMorgan@wrsgroup.com',),
            1 => 'smtp:EugeneMorgan@wntdom.wrsgroup.com',),
        'pwdlastset' =>
          array(
            0 => '129193775892725028',),
        'samaccountname' =>
          array(
            0 => 'emorgan',),
        'samaccounttype' =>
          array(
            0 => '805306368',),
        'scriptpath' =>
          array(
            0 => 'wrs_login_IT.vbs',),
        'showinaddressbook' =>
          array(
            0 => 'CN=Mailboxes(VLV),CN=All System Address Lists,CN=Address Lists Container,CN=WRS Group,CN=Microsoft Exchange,CN=Services,CN=Configuration,DC=wntdom,DC=wrsgroup,DC=com',
            1 => 'CN=All Mailboxes(VLV),CN=All System Address Lists,CN=Address Lists Container,CN=WRS Group,CN=Microsoft Exchange,CN=Services,CN=Configuration,DC=wntdom,DC=wrsgroup,DC=com',
            2 => 'CN=All Recipients(VLV),CN=All System Address Lists,CN=Address Lists Container,CN=WRS Group,CN=Microsoft Exchange,CN=Services,CN=Configuration,DC=wntdom,DC=wrsgroup,DC=com',
            3 => 'CN=Default Global Address List,CN=All Global Address Lists,CN=Address Lists Container,CN=WRS Group,CN=Microsoft Exchange,CN=Services,CN=Configuration,DC=wntdom,DC=wrsgroup,DC=com',
            4 => 'CN=All Users,CN=All Address Lists,CN=Address Lists Container,CN=WRS Group,CN=Microsoft Exchange,CN=Services,CN=Configuration,DC=wntdom,DC=wrsgroup,DC=com',),
        'sn' =>
          array(
            0 => 'Morgan',),
        'telephonenumber' =>
          array(
            0 => '(254) 776-6461 ext. 185',),
        'title' =>
          array(
            0 => 'Programmer',),
        'useraccountcontrol' =>
          array(
            0 => '512',),
        'userprincipalname' =>
          array(
            0 => 'emorgan@wntdom.wrsgroup.com',),
        'usnchanged' =>
          array(
            0 => '3983563',),
        'usncreated' =>
          array(
            0 => '8676',),
        'whenchanged' =>
          array(
            0 => '20100628204644.0Z',),
        'whencreated' =>
          array(
            0 => '20080427160729.0Z',),
    );

    public function testGetUser()
    {
        $mockLdap = $this->getMock('Zend_Ldap', array('search'));
        $mockIterator = $this->getMock(
            'Zend_Ldap_Collection_Iterator_Default',
            array(),
            array($mockLdap, 'resultId'),
            'MyMockIterator',
            false
        );
        $mockCollection = $this->getMock(
            'Zend_Ldap_Collection',
            array('getFirst'),
            array($mockIterator)
        );
        $mockCollection->expects($this->any())
            ->method('getFirst')
            ->will($this->returnValue($this->_ldapUserData));

        $mockLdap->expects($this->any())
            ->method('search')
            ->will($this->returnValue($mockCollection));

        $repo = new WrsGroup_Model_Repository_WrsUser();
        $repo->setLdap($mockLdap);
        $user = $repo->getUser('emorgan');
        $this->assertType('WrsGroup_Model_WrsUser', $user);
        $this->assertEquals('Eugene Morgan', $user->getDisplayName());
    }
}
